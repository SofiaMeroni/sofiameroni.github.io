name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types:
      - completed
  push:
    tags:
      - 'v*'

jobs:
  build_and_deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '2.7'
          bundler-cache: true

      - name: Check Ruby and Bundler version
        run: |
          ruby -v
          bundler -v
      
      - name: Build Jekyll site
        run: |
            bundle install --verbose
            bundle exec jekyll build
      
      - name: Capture build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: website-build
          path: _site/
      
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: _site
          branch: gh-pages
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            _site/**/*
          body: |
            # Release ${{ github.ref_name }}
            
            Automatic release from CD pipeline.
            
            ## What's Changed
            
            ${{ github.event.head_commit.message }}
